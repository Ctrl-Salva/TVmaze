<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Nova Série</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
            border: 1px solid #6c757d;
            border-radius: 0.375rem;
            background-color: #212529;
            min-height: 45px;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #0d6efd;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .tag-remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            background: none;
            border: none;
            color: white;
            padding: 0;
            font-size: 1.2rem;
        }
        .tag-input {
            flex: 1;
            min-width: 150px;
            border: none;
            background: transparent;
            color: #f8f9fa;
            outline: none;
        }
        .suggestions-list {
            position: absolute;
            z-index: 1000;
            background-color: #212529;
            border: 1px solid #6c757d;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 24px);
            display: none;
        }
        .suggestion-item {
            padding: 10px;
            cursor: pointer;
            color: #f8f9fa;
        }
        .suggestion-item:hover {
            background-color: #0d6efd;
        }
    </style>
</head>

<body class="bg-dark text-light">

    <div class="container py-5">

        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 text-light">
                <i class="bi bi-plus-circle"></i> Nova Série
            </h1>
            <a th:href="@{/admin/series}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>

        <!-- Mensagens -->
        <div th:if="${mensagem}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${mensagem}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${erro}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Formulário -->
        <div class="card bg-dark border-secondary shadow-sm">
            <div class="card-body">
                <form th:action="@{/admin/series/salvar}" th:object="${serie}" method="post" class="row g-3" id="serieForm">

                    <!-- Nome -->
                    <div class="col-md-6">
                        <label for="nome" class="form-label text-light">
                            <i class="bi bi-tv"></i> Nome *
                        </label>
                        <input type="text" id="nome" th:field="*{nome}"
                            class="form-control bg-dark text-light border-secondary" required>
                    </div>

                    <!-- Linguagem com Autocomplete -->
                    <div class="col-md-3">
                        <label for="linguagem" class="form-label text-light">
                            <i class="bi bi-globe"></i> Linguagem
                        </label>
                        <input type="text" id="linguagem" th:field="*{linguagem}"
                            class="form-control bg-dark text-light border-secondary"
                            list="linguagensList"
                            placeholder="Digite ou selecione...">
                        <datalist id="linguagensList">
                            <option th:each="ling : ${linguagens}" th:value="${ling}"></option>
                        </datalist>
                        <small class="text-secondary">Sugestões: <span th:if="${linguagens != null && !linguagens.isEmpty()}" th:text="${#strings.listJoin(linguagens, ', ')}"></span></small>
                    </div>

                    <!-- Nota -->
                    <div class="col-md-3">
                        <label for="nota" class="form-label text-light">
                            <i class="bi bi-star"></i> Nota
                        </label>
                        <input type="number" id="nota" th:field="*{nota}"
                            class="form-control bg-dark text-light border-secondary" 
                            step="0.1" min="0" max="10"
                            placeholder="0.0 - 10.0">
                    </div>

                    <!-- Data Estreia -->
                    <div class="col-md-3">
                        <label for="dataEstreia" class="form-label text-light">
                            <i class="bi bi-calendar-event"></i> Data de Estreia
                        </label>
                        <input type="date" id="dataEstreia" th:field="*{dataEstreia}"
                            class="form-control bg-dark text-light border-secondary">
                    </div>

                    <!-- Data Término -->
                    <div class="col-md-3">
                        <label for="dataTermino" class="form-label text-light">
                            <i class="bi bi-calendar-x"></i> Data de Término
                        </label>
                        <input type="date" id="dataTermino" th:field="*{dataTermino}"
                            class="form-control bg-dark text-light border-secondary">
                    </div>

                    <!-- Gêneros com Tags Input -->
                    <div class="col-md-6">
                        <label class="form-label text-light">
                            <i class="bi bi-tags"></i> Gêneros
                        </label>
                        <div class="position-relative">
                            <div class="tag-input-container" id="tagContainer">
                                <input type="text" 
                                       class="tag-input" 
                                       id="generoInput" 
                                       placeholder="Digite um gênero e pressione Enter..."
                                       autocomplete="off">
                            </div>
                            <div class="suggestions-list" id="suggestionsList"></div>
                        </div>
                        <small class="text-secondary">
                            Sugestões: 
                            <span class="badge bg-secondary me-1 suggestion-badge" 
                                  th:each="g : ${generos}" 
                                  th:text="${g.nome}"
                                  th:data-genero="${g.nome}"
                                  style="cursor: pointer;">
                            </span>
                        </small>
                    </div>

                    <!-- Imagem Original -->
                    <div class="col-md-6">
                        <label for="imagemOriginal" class="form-label text-light">
                            <i class="bi bi-image"></i> Imagem Original (URL)
                        </label>
                        <input type="text" id="imagemOriginal" th:field="*{imagem.original}"
                            class="form-control bg-dark text-light border-secondary"
                            placeholder="https://exemplo.com/imagem_original.jpg">
                    </div>

                    <!-- Imagem Média -->
                    <div class="col-md-6">
                        <label for="imagemMedio" class="form-label text-light">
                            <i class="bi bi-image"></i> Imagem Média (URL)
                        </label>
                        <input type="text" id="imagemMedio" th:field="*{imagem.medio}"
                            class="form-control bg-dark text-light border-secondary"
                            placeholder="https://exemplo.com/imagem_medio.jpg">
                    </div>

                    <!-- Sinopse -->
                    <div class="col-12">
                        <label for="sinopse" class="form-label text-light">
                            <i class="bi bi-file-text"></i> Sinopse
                        </label>
                        <textarea id="sinopse" th:field="*{sinopse}"
                            class="form-control bg-dark text-light border-secondary" 
                            rows="4"
                            placeholder="Descreva a série..."></textarea>
                    </div>

                    <!-- Botões -->
                    <div class="col-12 text-end">
                        <button type="reset" class="btn btn-secondary me-2">
                            <i class="bi bi-x-circle"></i> Limpar
                        </button>
                        <button type="submit" class="btn btn-primary px-4">
                            <i class="bi bi-check-circle"></i> Salvar
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        // Dados dos gêneros disponíveis
        const generosDisponiveis = /*[[${generos}]]*/ [];
        const generosNomes = generosDisponiveis.map(g => g.nome);
        
        // Array para armazenar os gêneros selecionados
        let generosSelecionados = [];
        
        const tagContainer = document.getElementById('tagContainer');
        const generoInput = document.getElementById('generoInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const form = document.getElementById('serieForm');
        
        // Função para adicionar tag
        function addTag(genero) {
            genero = genero.trim();
            if (!genero || generosSelecionados.includes(genero)) return;
            
            generosSelecionados.push(genero);
            
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `
                ${genero}
                <button type="button" class="tag-remove" onclick="removeTag('${genero}')">&times;</button>
            `;
            
            tagContainer.insertBefore(tag, generoInput);
            generoInput.value = '';
            suggestionsList.style.display = 'none';
        }
        
        // Função para remover tag
        function removeTag(genero) {
            generosSelecionados = generosSelecionados.filter(g => g !== genero);
            renderTags();
        }
        
        // Renderizar tags
        function renderTags() {
            const tags = tagContainer.querySelectorAll('.tag');
            tags.forEach(tag => tag.remove());
            
            generosSelecionados.forEach(genero => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${genero}
                    <button type="button" class="tag-remove" onclick="removeTag('${genero}')">&times;</button>
                `;
                tagContainer.insertBefore(tag, generoInput);
            });
        }
        
        // Input de gênero - Enter para adicionar
        generoInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(this.value);
            }
        });
        
        // Autocomplete de gêneros
        generoInput.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            suggestionsList.innerHTML = '';
            
            if (value.length === 0) {
                suggestionsList.style.display = 'none';
                return;
            }
            
            const filtered = generosNomes.filter(g => 
                g.toLowerCase().includes(value) && 
                !generosSelecionados.includes(g)
            );
            
            if (filtered.length > 0) {
                filtered.forEach(genero => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = genero;
                    item.onclick = () => addTag(genero);
                    suggestionsList.appendChild(item);
                });
                suggestionsList.style.display = 'block';
            } else {
                suggestionsList.style.display = 'none';
            }
        });
        
        // Fechar sugestões ao clicar fora
        document.addEventListener('click', function(e) {
            if (!tagContainer.contains(e.target)) {
                suggestionsList.style.display = 'none';
            }
        });
        
        // Badges clicáveis de sugestões
        document.querySelectorAll('.suggestion-badge').forEach(badge => {
            badge.addEventListener('click', function() {
                addTag(this.dataset.genero);
            });
        });
        
        // Adicionar inputs hidden ao submeter o form
        form.addEventListener('submit', function(e) {
            // Remover inputs de gêneros anteriores
            const oldInputs = form.querySelectorAll('input[name="generos"]');
            oldInputs.forEach(input => input.remove());
            
            // Adicionar novos inputs hidden
            generosSelecionados.forEach(genero => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'generos';
                input.value = genero;
                form.appendChild(input);
            });
        });
    </script>

</body>

</html>